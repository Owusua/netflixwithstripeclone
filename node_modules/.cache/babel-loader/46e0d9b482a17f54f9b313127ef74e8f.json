{"ast":null,"code":"import _regeneratorRuntime from\"/home/owusua/Videos/mynetflix-clone-papa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/owusua/Videos/mynetflix-clone-papa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/owusua/Videos/mynetflix-clone-papa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import React,{useState,useEffect}from\"react\";import{useSelector}from\"react-redux\";import{selectUser}from\"../features/userSlice\";import db from\"../firebase\";import\"./PlansScreen.css\";import{loadStripe}from\"@stripe/stripe-js\";function PlansScreen(){var _useState=useState([]),_useState2=_slicedToArray(_useState,2),products=_useState2[0],setProducts=_useState2[1];var user=useSelector(selectUser);var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),subscription=_useState4[0],setSubscription=_useState4[1];useEffect(function(){db.collection(\"customers\").doc(user.uid).collection(\"subscriptions\").get().then(function(querySnapshot){querySnapshot.forEach(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(subscription){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setSubscription({role:subscription.data().role,current_period_end:subscription.data().current_period_end.seconds,current_period_start:subscription.data().current_period_start.seconds});case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());});},[user.uid]);useEffect(function(){db.collection(\"products\").where(\"active\",\"==\",true).get().then(function(querySnapshot){var products={};querySnapshot.forEach(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(productDoc){var priceSnap;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:products[productDoc.id]=productDoc.data();_context2.next=3;return productDoc.ref.collection(\"prices\").get();case 3:priceSnap=_context2.sent;priceSnap.docs.forEach(function(price){products[productDoc.id].prices={priceId:price.id,priceData:price.data()};});case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());setProducts(products);});},[]);// console.log(products);\nconsole.log(subscription);var loadCheckout=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(priceId){var docRef;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return db.collection(\"customers\").doc(user.uid).collection(\"checkout_sessions\").add({price:priceId,success_url:window.location.origin,cancel_url:window.location.origin});case 2:docRef=_context4.sent;docRef.onSnapshot(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(snap){var _snap$data,error,sessionId,stripe;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_snap$data=snap.data(),error=_snap$data.error,sessionId=_snap$data.sessionId;if(error){//Show an error to you customer and inspect your Cloud function logs in the Firebase console\nalert(\"An error occured: \".concat(error.message));}if(!sessionId){_context3.next=7;break;}_context3.next=5;return loadStripe(\"pk_test_51HQzccJi6cwzy1sivjZse62bFU6ZV4ublhFLH6aMIueBQokwITmhy8NggRSCxyJqXaqwwZ0rbFK4kulwL72Cz8Dl00bbC8fabU\");case 5:stripe=_context3.sent;stripe.redirectToCheckout({sessionId:sessionId});case 7:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x4){return _ref4.apply(this,arguments);};}());case 4:case\"end\":return _context4.stop();}}},_callee4);}));return function loadCheckout(_x3){return _ref3.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(\"div\",{className:\"plansScreen\",children:[/*#__PURE__*/_jsx(\"br\",{}),subscription&&/*#__PURE__*/_jsxs(\"p\",{children:[\"Renewal date :\",new Date((subscription===null||subscription===void 0?void 0:subscription.current_period_end)*1000).toLocaleDateString()]}),Object.entries(products).map(function(_ref5){var _ref6=_slicedToArray(_ref5,2),productId=_ref6[0],productData=_ref6[1];//add some logic to check if users subscription is active\nvar isCurrentPackage=productData.name.includes(subscription===null||subscription===void 0?void 0:subscription.role);//alternative code\n// const isCurrentPackage = productData.name?.toLowerCase().includes(subscription?.role);\nreturn/*#__PURE__*/_jsxs(\"div\",{className:\"\".concat(isCurrentPackage&&\"plansScreen__plan--disabled\",\" plansScreen__plan\"),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"planScreen__info\",children:[/*#__PURE__*/_jsx(\"h5\",{children:productData.name}),/*#__PURE__*/_jsx(\"h5\",{children:productData.description})]}),/*#__PURE__*/_jsx(\"button\",{onClick:function onClick(){return loadCheckout(productData.prices.priceId);},children:isCurrentPackage?\"Current Package\":\"Subscribe\"})]},productId);})]});}export default PlansScreen;","map":{"version":3,"sources":["/home/owusua/Videos/mynetflix-clone-papa/src/screens/PlansScreen.js"],"names":["React","useState","useEffect","useSelector","selectUser","db","loadStripe","PlansScreen","products","setProducts","user","subscription","setSubscription","collection","doc","uid","get","then","querySnapshot","forEach","role","data","current_period_end","seconds","current_period_start","where","productDoc","id","ref","priceSnap","docs","price","prices","priceId","priceData","console","log","loadCheckout","add","success_url","window","location","origin","cancel_url","docRef","onSnapshot","snap","error","sessionId","alert","message","stripe","redirectToCheckout","Date","toLocaleDateString","Object","entries","map","productId","productData","isCurrentPackage","name","includes","description"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { useSelector } from \"react-redux\";\nimport { selectUser } from \"../features/userSlice\";\nimport db from \"../firebase\";\nimport \"./PlansScreen.css\";\nimport { loadStripe } from \"@stripe/stripe-js\";\n\nfunction PlansScreen() {\n  const [products, setProducts] = useState([]);\n  const user = useSelector(selectUser);\n  const [subscription, setSubscription] = useState(null);\n\n  useEffect(() => {\n    db.collection(\"customers\")\n      .doc(user.uid)\n      .collection(\"subscriptions\")\n      .get()\n      .then((querySnapshot) => {\n        querySnapshot.forEach(async (subscription) => {\n          setSubscription({\n            role: subscription.data().role,\n            current_period_end: subscription.data().current_period_end.seconds,\n            current_period_start: subscription.data().current_period_start\n              .seconds,\n          });\n        });\n      });\n  }, [user.uid]);\n\n  useEffect(() => {\n    db.collection(\"products\")\n      .where(\"active\", \"==\", true)\n      .get()\n      .then((querySnapshot) => {\n        const products = {};\n        querySnapshot.forEach(async (productDoc) => {\n          products[productDoc.id] = productDoc.data();\n          const priceSnap = await productDoc.ref.collection(\"prices\").get();\n          priceSnap.docs.forEach((price) => {\n            products[productDoc.id].prices = {\n              priceId: price.id,\n              priceData: price.data(),\n            };\n          });\n        });\n        setProducts(products);\n      });\n  }, []);\n  // console.log(products);\n  console.log(subscription);\n  const loadCheckout = async (priceId) => {\n    const docRef = await db\n      .collection(\"customers\")\n      .doc(user.uid)\n      .collection(\"checkout_sessions\")\n      .add({\n        price: priceId,\n        success_url: window.location.origin,\n        cancel_url: window.location.origin,\n      });\n    docRef.onSnapshot(async (snap) => {\n      const { error, sessionId } = snap.data();\n      if (error) {\n        //Show an error to you customer and inspect your Cloud function logs in the Firebase console\n        alert(`An error occured: ${error.message}`);\n      }\n      if (sessionId) {\n        // We have a session, lets redirect to Checkout,\n        //Initialize Stripe\n        const stripe = await loadStripe(\n          \"pk_test_51HQzccJi6cwzy1sivjZse62bFU6ZV4ublhFLH6aMIueBQokwITmhy8NggRSCxyJqXaqwwZ0rbFK4kulwL72Cz8Dl00bbC8fabU\"\n        );\n        stripe.redirectToCheckout({ sessionId });\n      }\n    });\n  };\n  return (\n    <div className=\"plansScreen\">\n      <br />\n      {subscription && (\n        <p>\n          Renewal date :\n          {new Date(\n            subscription?.current_period_end * 1000\n          ).toLocaleDateString()}\n        </p>\n      )}\n      {Object.entries(products).map(([productId, productData]) => {\n        //add some logic to check if users subscription is active\n        const isCurrentPackage = productData.name.includes(subscription?.role);\n        //alternative code\n        // const isCurrentPackage = productData.name?.toLowerCase().includes(subscription?.role);\n        return (\n          <div\n            key={productId}\n            className={`${\n              isCurrentPackage && \"plansScreen__plan--disabled\"\n            } plansScreen__plan`}\n          >\n            <div className=\"planScreen__info\">\n              <h5>{productData.name}</h5>\n              <h5>{productData.description}</h5>\n            </div>\n            <button onClick={() => loadCheckout(productData.prices.priceId)}>\n              {isCurrentPackage ? \"Current Package\" : \"Subscribe\"}\n            </button>\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n\nexport default PlansScreen;\n"]},"metadata":{},"sourceType":"module"}